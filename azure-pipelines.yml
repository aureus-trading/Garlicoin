# Docker
# Build a Docker image
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
  branches:
    include:
    - refs/heads/develop
    - refs/heads/release

resources:
  repositories:
  - repository: self

variables:
  imageRepositoryServiceName: 'garlicoin-node'
  containerRegistry: 'polarity-acr-svc-connect-09122022'
  tag: '$(Build.BuildId)'

pool:
  vmImage: 'ubuntu-latest'

stages:
- stage: Build_Push_Service_dev
  displayName: Build_Push_Service_dev
  jobs:
  - job: Build_Push_Service_dev
    displayName: Build_Push_Service_dev
    condition: eq( variables['Build.SourceBranchName'], 'develop' )
    steps:
    - checkout: self
      clean: true
    - bash: |
        export GIT_COMMIT=$(git rev-parse --short HEAD)
        echo "##vso[task.setvariable variable=GIT_COMMIT]${GIT_COMMIT}"
    - task: Docker@2
      displayName: Build_Push_Service_dev
      inputs:
        containerRegistry: $(containerRegistry)
        repository:  $(imageRepositoryServiceName)
        command: 'buildAndPush'
        Dockerfile: 'Dockerfile'
        tags: |
          $(Build.SourceBranchName)
          $(tag)
          $(Build.SourceVersion)
          $(GIT_COMMIT)

- stage: Build_Push_Service_release
  displayName: Build_Push_Service_release
  jobs:
  - job: Build_Push_Service_release
    displayName: Build_Push_Service_release
    condition: eq( variables['Build.SourceBranchName'], 'release' )
    steps:
    - checkout: self
      clean: true
    - bash: |
        export GIT_COMMIT=$(git rev-parse --short HEAD)
        echo "##vso[task.setvariable variable=GIT_COMMIT]${GIT_COMMIT}"
    - task: Docker@2
      displayName: Build_Push_Service_release
      inputs:
        containerRegistry: $(containerRegistry)
        repository:  $(imageRepositoryServiceName)
        command: 'buildAndPush'
        Dockerfile: 'Dockerfile'
        tags: |
          $(Build.SourceBranchName)
          $(tag)
          $(Build.SourceVersion)
          $(GIT_COMMIT)

- stage: Build_Push_Service_pr
  displayName: Build_Push_Service_pr
  jobs:
  - job: Build_Push_Service_pr
    displayName: Build_Push_Service_pr
    condition: eq( variables['Build.Reason'], 'PullRequest' )
    steps:
    - checkout: self
      clean: true
    - bash: |
        export GIT_COMMIT=$(git rev-parse --short HEAD)
        echo "##vso[task.setvariable variable=GIT_COMMIT]${GIT_COMMIT}"
    - task: Docker@2
      displayName: Build_Push_Service_pr
      inputs:
        containerRegistry: $(containerRegistry)
        repository:  $(imageRepositoryServiceName)
        command: 'buildAndPush'
        Dockerfile: 'Dockerfile'
        tags: |
          $(Build.SourceBranchName)
          $(tag)
          $(Build.SourceVersion)
          $(GIT_COMMIT)